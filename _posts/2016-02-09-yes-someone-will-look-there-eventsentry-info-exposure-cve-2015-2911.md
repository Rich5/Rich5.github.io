---
id: 407
title: 'Yes, someone will look there &#8211; EventSentry Info Exposure &#8211; CVE-2015-2911'
date: 2016-02-09T16:07:07+00:00
author: Rich
layout: post
guid: http://bytesdarkly.com/?p=407
permalink: /2016/02/yes-someone-will-look-there-eventsentry-info-exposure-cve-2015-2911/
categories:
  - Uncategorized
---
# Intro

<span style="font-weight: 400;">Information disclosure vulnerabilities are not the most exciting bugs in the business, and some bug hunters don’t even consider them worthy of note. I’m not going to weigh into that debate, but we recently came across such a bug in EventSentry, and I think it was at least worth discussing here as a case study in application security. This is a relatively minor bug &#8211; no RCE, no fancy ASLR bypass, this is simply a case where the developers probably thought no one would look there. Actually we discovered two vulnerabilities including a directory traversal &#8211; <a href="https://twitter.com/ruddawg26">@ruddawg26’s</a> write-up on that can be found </span>[<span style="font-weight: 400;">here</span>](http://securitymumblings.blogspot.com/2016/01/CVE-2015-2910.html)<span style="font-weight: 400;">.</span>

<span style="font-weight: 400;">Before we get started I would like to point out that NETIKUS.NET ltd, the maker of EventSentry, does appear to take security seriously. There are few </span>[<span style="font-weight: 400;">public vulnerabilities</span>](https://web.nvd.nist.gov/view/vuln/search-results?query=eventsentry&search_type=all&cves=on) <span style="font-weight: 400;">for EventSentry, and they were really responsive to our report. Both of our findings were patched  as of </span>[<span style="font-weight: 400;">version 3.1.1.90</span>](http://www.eventsentry.com/downloads/latest-patch) <span style="font-weight: 400;"> </span>

## Background

<span style="font-weight: 400;">For those unfamiliar, EventSentry is a Security Information & Event Management (SIEM) solution. To paraphrase from the EventSentry website,</span>

> <span style="font-weight: 400;">[EventSentry] aggregates and correlate logs, alert engineers in real-time of security issues, provide insight into data through dashboards and easy to use reports and help with a variety of compliance requirements</span>
> 
> <span style="font-weight: 400;">EventSentry offers the following SIEM-related functionality:</span>
> 
>   * Real-Time Windows Event Log Monitoring with local rule processing
>   * <span style="font-weight: 400;">Real-Time Log File Monitoring (with local rule processing)</span>
>   * <span style="font-weight: 400;">Complete Log Consolidation (Event Log, Log Files, Syslog, SNMP)</span>
>   * <span style="font-weight: 400;">Correlation of various Windows security events</span>
>   * <span style="font-weight: 400;">Forensic analysis of collected data through powerful search queries</span>
>   * <span style="font-weight: 400;">Secure data transmission to central repository</span>
>   * <span style="font-weight: 400;">RBAC to web-based reporting</span>
> 
> &nbsp;

<span style="font-weight: 400;">I only mention these features to highlight that EventSentry has access to a lot of data on the host which means it’s necessary for the agent to run with elevated privileges. Configurations vary, but in general the EventSentry suite consists of a management console, host agent, web reporting, and a back-end database. </span>

<span style="font-weight: 400;">The management console is capable of installing and configuring agents, updating configurations, and updating agent software across the network. It’s the configuration updates process that we’re going to focus on.</span>

# CVE-2015-2911

<span style="font-weight: 400;">To update agents an admin simply makes the desired configuration changes via the management console, and then pushes updates down to the agents. This push action is accomplished by sending a configuration file to each agent. The configuration file is compressed (.zip) and sent over the wire where it’s downloaded to the local installation directory. Once the zip file has been downloaded the agent unzips the file and loads the new configuration file. The EventSentry agent stores nearly all of it’s configuration settings in the Windows registry. To update the agent configuration, the software loads a .reg file with all the new settings. It’s here in this update process that, for a brief instant, information is exposed. </span>

<span style="font-weight: 400;">If you watch the install directory, </span>_<span style="font-weight: 400;">C:\Windows\SysWOW64\EVENTSENTRY</span>_<span style="font-weight: 400;">, you can actually watch the new configuration file appear during an update. By default a regular user only has READ access to this directory so manipulating the config in flight isn’t likely. From watching this behavior we can see that the programmers needed to know when the config file was ready to be loaded so they used a flag file to indicate the download was complete. This is easily seen in the image below with the appearance of the </span>_<span style="font-weight: 400;">eventsentry_svc.zip.complete</span>_ <span style="font-weight: 400;">file.</span>

<a href="/images/2016/02/eventsentry_install_path.png" rel="attachment wp-att-416"><img class="wp-image-416" src="/images/2016/02/eventsentry_install_path.png" alt="eventsentry_install_path" width="756" height="277" srcset="/images/2016/02/eventsentry_install_path.png 686w, /images/2016/02/eventsentry_install_path-300x110.png 300w" sizes="(max-width: 756px) 100vw, 756px" /></a>

<p style="text-align: center;">
  EventSentry agent configuration update
</p>

<span style="font-weight: 400;">Once the flag file appears the agent unzips the <em>eventsentry_svc.zip</em> file and loads the new<em> eventsentry_svc.reg</em> configuration into the registry. After the new config is loaded the agent then deletes the .reg file because it contains, among other things, cleartext passwords!</span>

# Exploitation

<span style="font-weight: 400;">As I mentioned above a regular user has READ access to the install directory by default. So all we need to do is copy the <em>eventsentry_svc.zip</em> file before it’s deleted and we have access to all the configuration information that the EventSentry agent uses. There are many ways you can do this, but an easy way is to just use a quick PowerShell script. You can get as fancy as you like with this in practice, but a quick PoC is shown below:</span>

<pre style="font-family: arial; font-size: 12px; border: 1px dashed #CCCCCC; width: 99%; height: auto; overflow: auto; background: #f0f0f0; ;background-image: url('http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif'); padding: 0px; color: #000000; text-align: left; line-height: 20px;"><code style="color: #000000; word-wrap: normal;"> while(1){  
      $flag = “C:\Windows\SysWOW64\EVENTSENTRY\eventsentry_svc.zip.complete”  
      $file = “C:\Windows\SysWOW64\EVENTSENTRY\eventsentry_svc.zip”  
      if(Test-Path -path $flag){  
           try{  
                cp $file C:\Users\user\Desktop\eventsentry_svc.zip  
                break  
           } catch { “...” }  
      }  
 }  
</code></pre>

# <span style="font-weight: 400;">Information Exposure</span>

<span style="font-weight: 400;">Searching through the .reg file there is A LOT of information. Included in the config are login credentials for the EventSentry database and any SMTP server the agent uses to send notifications as shown in the screenshots below.</span>

&nbsp;

<a href="/images/2016/02/eventsentry_dbpassword.png" rel="attachment wp-att-415"><img class="aligncenter size-full wp-image-415" src="/images/2016/02/eventsentry_dbpassword.png" alt="eventsentry_dbpassword" width="949" height="285" srcset="/images/2016/02/eventsentry_dbpassword.png 949w, /images/2016/02/eventsentry_dbpassword-300x90.png 300w, /images/2016/02/eventsentry_dbpassword-768x231.png 768w" sizes="(max-width: 949px) 100vw, 949px" /></a>

<a href="/images/2016/02/eventsentry_smtp_config.png" rel="attachment wp-att-418"><img class="aligncenter size-full wp-image-418" src="/images/2016/02/eventsentry_smtp_config.png" alt="eventsentry_smtp_config" width="558" height="676" srcset="/images/2016/02/eventsentry_smtp_config.png 558w, /images/2016/02/eventsentry_smtp_config-248x300.png 248w" sizes="(max-width: 558px) 100vw, 558px" /></a>

# Conclusion

Obviously this only helps in a post-exploitation scenario, and to be perfectly honest it&#8217;s unlikely you would use this on a quick penetration test. However, once you have gained access to a system that runs the EventSentry agent why not run a small script in the background just in case the admins push an update? If you get lucky you might have just landed credentials to the EventSentry database or more. Overall, this isn&#8217;t a huge vulnerability for EventSentry, but this is the sort of thing a persistent adversary might use to gain access to more information. For the developers reading this &#8211; I understand your plight. You have a job to do which is to get a user friendly, working, product to market. Application security is hard, and it&#8217;s nearly impossible to think about all the fringe cases that may be exploited, but what choice do we have.